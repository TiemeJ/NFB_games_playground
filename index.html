<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyndBand Final Visualizer</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 40px; color: #333; }
        
        h1 { margin-bottom: 10px; color: #2c3e50; }
        .status-pill { padding: 8px 20px; border-radius: 50px; font-weight: bold; font-size: 0.9em; margin-bottom: 30px; background: #dfe6e9; color: #636e72; }
        .status-pill.connected { background: #55efc4; color: #00b894; color: #004d40; }
        .status-pill.error { background: #ff7675; color: #fff; }

        button { 
            padding: 15px 40px; font-size: 18px; font-weight: bold; 
            background: #0984e3; color: white; border: none; border-radius: 8px; 
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        button:hover { background: #0069d9; transform: translateY(-2px); }
        button:disabled { background: #b2bec3; cursor: not-allowed; transform: none; }

        /* Visualizer Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 800px; margin-top: 40px; }
        
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); text-align: center; }
        .card h3 { margin: 0 0 15px 0; color: #b2bec3; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        
        .big-number { font-size: 4em; font-weight: bold; color: #2d3436; margin-bottom: 10px; }
        
        /* Signal Quality Indicator */
        #sig-val { font-size: 2em; }
        .sig-good { color: #00b894; }
        .sig-ok { color: #fdcb6e; }
        .sig-bad { color: #d63031; }

        /* Bar Graphs */
        .bar-container { width: 100%; height: 10px; background: #ecf0f1; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.5s ease-out; }
        #att-bar { background: #e17055; }
        #med-bar { background: #00cec9; }

        #debug { margin-top: 50px; color: #b2bec3; font-family: monospace; font-size: 0.8em; }
    </style>
</head>
<body>

    <h1>ðŸ§  MyndBand Visualizer</h1>
    <div id="status" class="status-pill">Ready to Connect</div>
    
    <button id="connectBtn">CONNECT HEADSET</button>

    <div class="grid">
        <!-- Signal Quality -->
        <div class="card" style="grid-column: span 2;">
            <h3>Signal Quality</h3>
            <div id="sig-val" class="big-number sig-bad">--</div>
            <div id="sig-text" style="font-size: 0.9em; color: #636e72;">Connect to start</div>
        </div>

        <!-- Attention -->
        <div class="card">
            <h3>Focus (Attention)</h3>
            <div id="att-val" class="big-number">0</div>
            <div class="bar-container"><div id="att-bar" class="bar-fill"></div></div>
        </div>

        <!-- Meditation -->
        <div class="card">
            <h3>Relaxation (Meditation)</h3>
            <div id="med-val" class="big-number">0</div>
            <div class="bar-container"><div id="med-bar" class="bar-fill"></div></div>
        </div>
    </div>

    <div id="debug">Raw packet counts will appear here...</div>

    <script>
        const btn = document.getElementById('connectBtn');
        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug');
        
        // The service and char you found
        const SERVICE_UUID = "039afff0-2c94-11e3-9e06-0002a5d5c51b"; 

        let buffer = [];
        let packetCount = 0;

        btn.addEventListener('click', async () => {
            try {
                updateStatus("Searching...", "");
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Mynd' }, { namePrefix: 'Mind' }, { namePrefix: 'Brain' }],
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus("Connecting...", "");
                const server = await device.gatt.connect();
                
                const service = await server.getPrimaryService(SERVICE_UUID);
                const chars = await service.getCharacteristics();
                
                // Find the Notify characteristic
                const notifyChar = chars.find(c => c.properties.notify);
                if(!notifyChar) throw new Error("No data stream found");

                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleData);

                updateStatus("Connected & Streaming", "connected");
                btn.innerText = "Connected";
                btn.disabled = true;

            } catch (e) {
                updateStatus("Error: " + e.message, "error");
            }
        });

        function updateStatus(msg, type) {
            statusEl.innerText = msg;
            statusEl.className = "status-pill " + type;
        }

        // --- CUSTOM PARSER FOR YOUR DEVICE ---
        // Based on your screenshot: 00 00 EA 00 00 02 C8 04 00 05 00
        function handleData(event) {
            const data = new Uint8Array(event.target.value.buffer);
            
            // Add to buffer
            for(let b of data) buffer.push(b);
            if(buffer.length > 512) buffer.shift(); // Prevent overflow

            // Scan for the pattern: [00, 00, EA]
            while(buffer.length >= 12) { // Need at least 11-12 bytes for a full packet
                
                // Check header 00 00 EA
                if(buffer[0] === 0x00 && buffer[1] === 0x00 && buffer[2] === 0xEA) {
                    
                    // We found the header!
                    // Expected offsets based on screenshot:
                    // [5] = 02 (Signal Code)
                    // [6] = Signal Value
                    // [7] = 04 (Attention Code)
                    // [8] = Attention Value
                    // [9] = 05 (Meditation Code)
                    // [10] = Meditation Value

                    // Verify codes to be safe (in case packet shifts)
                    if(buffer[5] === 0x02 && buffer[7] === 0x04 && buffer[9] === 0x05) {
                        const signal = buffer[6];
                        const attention = buffer[8];
                        const meditation = buffer[10];

                        updateUI(signal, attention, meditation);
                        packetCount++;
                        debugEl.innerText = `Packets Received: ${packetCount} | Last Signal: ${signal}`;
                    }

                    // Remove this packet from buffer
                    buffer.splice(0, 12); 
                } else {
                    // Not a header, shift one byte
                    buffer.shift();
                }
            }
        }

        function updateUI(sig, att, med) {
            // Signal Quality
            const sigEl = document.getElementById('sig-val');
            const sigText = document.getElementById('sig-text');
            
            if(sig === 0) {
                sigEl.innerText = "Good";
                sigEl.className = "big-number sig-good";
                sigText.innerText = "Clean Signal (0)";
            } else if(sig === 200) {
                sigEl.innerText = "Sensors Off";
                sigEl.className = "big-number sig-bad";
                sigText.innerText = "Check Headset Contact (200)";
            } else {
                sigEl.innerText = "Noise";
                sigEl.className = "big-number sig-ok";
                sigText.innerText = `Interference: ${sig} (Wait for 0)`;
            }

            // Attention
            document.getElementById('att-val').innerText = att;
            document.getElementById('att-bar').style.width = att + "%";

            // Meditation
            document.getElementById('med-val').innerText = med;
            document.getElementById('med-bar').style.width = med + "%";
        }
    </script>
</body>
</html>
