<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroScope V18: Fire Hose</title>
    <style>
        :root { --bg: #000; --text: #eee; --accent: #ff9900; --green: #00ff00; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        h1 { margin: 0 0 20px 0; border-bottom: 2px solid var(--accent); color: #fff; }

        .dash { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 800px; }
        
        .box { background: #111; padding: 20px; border: 1px solid #333; text-align: center; border-radius: 8px; }
        .val { font-size: 3em; font-weight: bold; color: #fff; }
        .lbl { color: #888; font-size: 0.8em; text-transform: uppercase; }
        
        button { background: var(--accent); color: #000; padding: 15px; font-weight: bold; border: none; cursor: pointer; font-size: 16px; width: 100%; margin-top: 10px; }
        button:hover { filter: brightness(1.1); }
        button:disabled { background: #333; color: #555; cursor: default; }

        #log { width: 100%; max-width: 800px; height: 300px; background: #050505; border: 1px solid #333; margin-top: 20px; overflow-y: scroll; font-size: 11px; padding: 10px; color: #888; }
        .tx { color: var(--accent); }
        .success { color: var(--green); background: #003300; padding: 2px; }
    </style>
</head>
<body>

    <h1>NEUROSCOPE V18: FIRE HOSE</h1>
    
    <div class="dash">
        <div class="box">
            <div class="lbl">Last Injected</div>
            <div class="val" id="curr-key" style="color:var(--accent)">--</div>
        </div>
        <div class="box">
            <div class="lbl">Stream Speed</div>
            <div class="val" id="bps">0</div>
        </div>
    </div>
    
    <button id="btn">CONNECT & START FIRE HOSE</button>

    <div id="log">Ready.</div>

    <script>
        // ════ CONFIG ════
        const SERVICES = [
            "0000ffe0-0000-1000-8000-00805f9b34fb", // Serial
            "039afff0-2c94-11e3-9e06-0002a5d5c51b"  // MyndBand
        ];

        // ════ STATE ════
        let writeChar;
        let byteCount = 0;
        let lastByteCount = 0;
        let scanIdx = 0;
        let timer;
        
        // ════ UI ════
        const ui = {
            btn: document.getElementById('btn'),
            key: document.getElementById('curr-key'),
            bps: document.getElementById('bps'),
            log: document.getElementById('log')
        };

        function log(msg, cls='') {
            const d = document.createElement('div');
            d.innerHTML = `> ${msg}`;
            if(cls) d.classList.add(cls);
            ui.log.prepend(d);
            // Limit log size
            if(ui.log.children.length > 200) ui.log.lastElementChild.remove();
        }

        // ════ MAIN ════
        ui.btn.addEventListener('click', async () => {
            try {
                // 1. CONNECT
                log("Scanning...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Mynd' }, { namePrefix: 'Mind' }, { namePrefix: 'Brain' }],
                    optionalServices: SERVICES
                });

                log("Connecting...");
                const server = await device.gatt.connect();
                
                // 2. SETUP
                const services = await server.getPrimaryServices();
                for (const s of services) {
                    const chars = await s.getCharacteristics();
                    for (const c of chars) {
                        // Priority: FFE1
                        if (c.uuid.includes('ffe1')) writeChar = c;
                        else if ((c.properties.write || c.properties.writeWithoutResponse) && !writeChar) writeChar = c;
                        
                        if (c.properties.notify) {
                            await c.startNotifications();
                            c.addEventListener('characteristicvaluechanged', (e) => {
                                byteCount += e.target.value.byteLength;
                            });
                        }
                    }
                }

                if(!writeChar) throw new Error("No Write Channel!");
                log(`Injector attached to ...${writeChar.uuid.substring(4,8)}`);
                
                // 3. START
                ui.btn.disabled = true;
                ui.btn.innerText = "RUNNING...";
                
                // Speedometer
                setInterval(() => {
                    const speed = byteCount - lastByteCount;
                    lastByteCount = byteCount;
                    ui.bps.innerText = speed;
                    if(speed > 500) {
                        clearInterval(timer); // STOP SCANNING
                        log(`!!! UNLOCKED !!! Speed: ${speed} Bps`, 'success');
                        ui.key.style.color = "#00ff00";
                        ui.key.innerText = "DONE";
                    }
                }, 1000);

                // Fire Hose Loop
                nextKey();

            } catch (e) {
                log("Error: " + e.message);
                ui.btn.disabled = false;
            }
        });

        function nextKey() {
            if(scanIdx > 255) scanIdx = 0; // Loop forever
            
            const hex = "0x" + scanIdx.toString(16).toUpperCase().padStart(2,'0');
            ui.key.innerText = hex;
            
            const cmd = new Uint8Array([scanIdx]);
            
            // FIRE AND FORGET (No Await on purpose, or minimal await)
            if(writeChar.properties.writeWithoutResponse) {
                writeChar.writeValueWithoutResponse(cmd).catch(e => {});
            } else {
                writeChar.writeValue(cmd).catch(e => {});
            }
            
            log(`Injecting ${hex}...`, 'tx');
            scanIdx++;
            
            // Speed of injection (100ms)
            timer = setTimeout(nextKey, 100); 
        }

    </script>
</body>
</html>
