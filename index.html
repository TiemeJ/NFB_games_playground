<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroOscilloscope V2 (Force Mode)</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #00f2ea; --warn: #ff9f43; }
        body { font-family: 'Segoe UI', monospace; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; }
        .subtitle { color: #888; font-size: 0.8em; margin-bottom: 20px; }
        
        /* Controls */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        button { padding: 10px 20px; font-size: 14px; font-weight: bold; background: var(--accent); color: #000; border: none; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
        button:hover { filter: brightness(1.2); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }
        
        .btn-force { background: var(--warn); color: #000; }

        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: 1fr; gap: 20px; width: 100%; max-width: 1000px; }
        .card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .canvas-container { width: 100%; height: 250px; background: #000; border-radius: 4px; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }

        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; }
        .stat-box { background: #252525; padding: 10px; text-align: center; border-radius: 4px; }
        .stat-val { font-size: 1.2em; font-weight: bold; color: #fff; }
        .stat-label { font-size: 0.7em; color: #888; }

        /* Debug Log */
        #debug-log { 
            font-family: 'Courier New', monospace; 
            font-size: 11px; 
            color: #0f0; 
            height: 120px; 
            overflow-y: auto; 
            background: #000; 
            padding: 10px; 
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>

    <h1>NEURO<span style="color:var(--accent)">OSCILLOSCOPE</span> V2</h1>
    <div class="subtitle">512Hz Raw Data • Force Mode Enabled</div>

    <div class="controls">
        <button id="connectBtn">1. Connect</button>
        <button id="forceBtn" class="btn-force" disabled>2. Force 512Hz Mode</button>
        <button id="freezeBtn" disabled>Freeze</button>
    </div>

    <div class="dashboard">
        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-label">Packet Rate</div>
                <div class="stat-val" id="val-fps">0 pps</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Signal</div>
                <div class="stat-val" id="val-quality">--</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Attention</div>
                <div class="stat-val" id="val-att">--</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Meditation</div>
                <div class="stat-val" id="val-med">--</div>
            </div>
        </div>

        <div class="card">
            <div class="canvas-container">
                <canvas id="rawCanvas"></canvas>
            </div>
        </div>

        <div class="card">
            <div style="margin-bottom:5px; color:#666; font-size:10px;">DEBUG LOG (HEX DUMP)</div>
            <div id="debug-log">> Ready. Click Connect.</div>
        </div>
    </div>

    <script>
        // ════ CONFIG ════
        const SERVICE_UUID = "039afff0-2c94-11e3-9e06-0002a5d5c51b"; 
        const NOTIFY_UUID  = "039afff8-2c94-11e3-9e06-0002a5d5c51b"; // Read/Notify
        const WRITE_UUID   = "039afff9-2c94-11e3-9e06-0002a5d5c51b"; // Write Command

        // ════ STATE ════
        let device, server, service, notifyChar, writeChar;
        let isFreezed = false;
        let packetCount = 0;
        
        // Buffers
        const RAW_SIZE = 512 * 3; 
        let rawBuffer = new Array(RAW_SIZE).fill(0);
        
        // UI
        const rawCanvas = document.getElementById('rawCanvas');
        const ctx = rawCanvas.getContext('2d');
        const debugEl = document.getElementById('debug-log');
        
        function resize() {
            rawCanvas.width = rawCanvas.parentElement.clientWidth;
            rawCanvas.height = rawCanvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function log(msg) {
            const line = document.createElement('div');
            line.innerText = "> " + msg;
            debugEl.appendChild(line);
            debugEl.scrollTop = debugEl.scrollHeight;
        }

        // ════ BLUETOOTH ════
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                log("Scanning...");
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Mynd' }, { namePrefix: 'Mind' }, { namePrefix: 'Brain' }],
                    optionalServices: [SERVICE_UUID]
                });

                log("Connecting GATT...");
                server = await device.gatt.connect();
                service = await server.getPrimaryService(SERVICE_UUID);

                // Get Characteristics
                log("Getting Characteristics...");
                const chars = await service.getCharacteristics();
                
                // Find Notify (fff8) and Write (fff9)
                notifyChar = chars.find(c => c.uuid.includes("fff8")) || chars[0];
                writeChar  = chars.find(c => c.uuid.includes("fff9"));

                // Fallback: If fff9 not found, try to write to fff8
                if (!writeChar && notifyChar.properties.write) writeChar = notifyChar;

                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleData);
                
                log("Connected! Listening...");
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').innerText = "Connected";
                document.getElementById('forceBtn').disabled = false;
                document.getElementById('freezeBtn').disabled = false;

                // Start Visuals
                requestAnimationFrame(drawLoop);
                setInterval(() => {
                    document.getElementById('val-fps').innerText = packetCount + " pps";
                    packetCount = 0;
                }, 1000);

            } catch (e) {
                log("ERR: " + e);
            }
        });

        // ════ COMMAND INJECTION ════
        document.getElementById('forceBtn').addEventListener('click', async () => {
            if (!writeChar) { log("No Write Characteristic found!"); return; }
            
            try {
                // Command 0x02 is the standard NeuroSky "Enable Raw" command
                const cmd = new Uint8Array([0x02]); 
                // Alternatively try 0x00 if 0x02 fails
                // const cmd = new Uint8Array([0x00]); 
                
                log("Sending Command: 0x02 (Force Raw)...");
                await writeChar.writeValue(cmd);
                log("Command Sent! Watch graph...");
            } catch(e) {
                log("Write Failed: " + e);
            }
        });

        document.getElementById('freezeBtn').addEventListener('click', () => {
            isFreezed = !isFreezed;
        });

        // ════ PARSER ════
        // We buffer bytes because BLE splits packets randomly
        let buffer = []; 
        
        function handleData(event) {
            const data = new Uint8Array(event.target.value.buffer);
            packetCount++;

            // HEX DUMP DEBUG (First 50 packets only to avoid lag)
            // if (packetCount < 50) {
            //     const hex = Array.from(data).map(b => b.toString(16).padStart(2,'0')).join(' ');
            //     log(`RX: ${hex}`);
            // }

            // Push to main buffer
            for (let i=0; i<data.length; i++) buffer.push(data[i]);
            
            // Limit buffer size to prevent memory leak if sync fails
            if (buffer.length > 2048) buffer.splice(0, 1024);

            processBuffer();
        }

        function processBuffer() {
            while (buffer.length >= 3) {
                // Look for Sync Bytes
                // Standard NeuroSky: [AA] [AA]
                if (buffer[0] === 0xAA && buffer[1] === 0xAA) {
                    // We found a standard packet!
                    const len = buffer[2];
                    if (buffer.length >= 3 + len + 1) {
                        // Extract Payload
                        const payload = buffer.slice(3, 3 + len);
                        const checksum = buffer[3 + len];
                        
                        // Verify Checksum
                        let sum = 0;
                        for (let b of payload) sum += b;
                        sum = (~sum) & 0xFF;

                        if (sum === checksum) {
                            parsePayload(payload);
                            // Remove this packet from buffer
                            buffer.splice(0, 3 + len + 1);
                        } else {
                            // Bad checksum, shift 1 byte and retry
                            buffer.shift(); 
                        }
                    } else {
                        // Wait for more data
                        return;
                    }
                } 
                // MyndBand Wrapper: [00] [00] ... [AA] [AA] inside? 
                // Or [00] [00] [TYPE] ...
                else if (buffer[0] === 0x00 && buffer[1] === 0x00) {
                    // This is likely a wrapper. Remove header and see what's next.
                    // Usually MyndBand sends 00 00 [Type] 00 ...
                    // If we strip the first 2 bytes, the next loop might catch AA AA if it's embedded,
                    // or we might need to parse specific MyndBand types (EB/EC).
                    // For now, let's just strip them to expose inner data.
                    buffer.shift(); 
                    buffer.shift(); 
                }
                else {
                    // Garbage byte, shift
                    buffer.shift();
                }
            }
        }

        function parsePayload(payload) {
            let i = 0;
            while (i < payload.length) {
                const code = payload[i];
                
                // 0x80 = RAW WAVE (2 bytes big-endian)
                if (code === 0x80) {
                    const len = payload[i+1]; // Should be 2
                    const val = (payload[i+2] << 8) | payload[i+3];
                    
                    // Convert signed 16-bit
                    let raw = val;
                    if (raw >= 32768) raw -= 65536;
                    
                    if (!isFreezed) {
                        rawBuffer.push(raw);
                        rawBuffer.shift();
                    }
                    i += 4;
                }
                // 0x02 = Signal Quality
                else if (code === 0x02) {
                    const q = payload[i+1];
                    document.getElementById('val-quality').innerText = q === 0 ? "Good" : (q===200?"Off":"Noise");
                    i += 2;
                }
                // 0x04 = Attention
                else if (code === 0x04) {
                    document.getElementById('val-att').innerText = payload[i+1];
                    i += 2;
                }
                // 0x05 = Meditation
                else if (code === 0x05) {
                    document.getElementById('val-med').innerText = payload[i+1];
                    i += 2;
                }
                else {
                    // Unknown code, try to skip
                    i++;
                }
            }
        }

        // ════ RENDER ════
        function drawLoop() {
            if (isFreezed) { requestAnimationFrame(drawLoop); return; }

            ctx.clearRect(0, 0, rawCanvas.width, rawCanvas.height);
            ctx.strokeStyle = "#00f2ea";
            ctx.lineWidth = 2;
            ctx.beginPath();

            const slice = rawBuffer.slice(rawBuffer.length - 1024);
            const w = rawCanvas.width;
            const h = rawCanvas.height;
            const step = w / slice.length;

            for (let i = 0; i < slice.length; i++) {
                const x = i * step;
                // Scale factor: Raw is +/- 2000ish typically. 
                // We map that to screen height. 
                const y = (h/2) - (slice[i] * 0.15); 
                if (i===0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            requestAnimationFrame(drawLoop);
        }
    </script>
</body>
</html>
