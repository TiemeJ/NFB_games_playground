<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyndBand Connected</title>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f4f6f9; display: flex; flex-direction: column; align-items: center; padding: 40px; margin: 0; color: #333; }
        
        /* Header & Connect Button */
        h1 { margin-bottom: 10px; font-weight: 700; color: #2c3e50; }
        .status-bar { margin-bottom: 30px; font-size: 0.9em; font-weight: 600; padding: 8px 16px; border-radius: 20px; background: #dfe6e9; color: #636e72; transition: 0.3s; }
        .status-bar.connected { background: #d4edda; color: #155724; }
        .status-bar.error { background: #f8d7da; color: #721c24; }
        
        button { 
            padding: 14px 28px; font-size: 16px; font-weight: 600; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; border: none; border-radius: 50px; 
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
        button:disabled { background: #b2bec3; transform: none; box-shadow: none; cursor: not-allowed; }

        /* Dashboard Grid */
        .dashboard { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px; width: 100%; max-width: 600px; }
        
        .card { 
            background: white; padding: 30px 20px; border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; 
            transition: transform 0.3s;
        }
        .card:hover { transform: translateY(-5px); }
        
        .label { font-size: 0.8em; text-transform: uppercase; letter-spacing: 2px; color: #a4b0be; font-weight: 700; margin-bottom: 10px; }
        .value { font-size: 3.5em; font-weight: 700; color: #2d3436; line-height: 1; }
        
        /* Specific Colors for Data */
        #attention { color: #e17055; }
        #meditation { color: #00cec9; }
        
        /* Log Area */
        #log { 
            margin-top: 50px; width: 100%; max-width: 600px; 
            font-family: monospace; font-size: 0.85em; color: #b2bec3; 
            text-align: center; white-space: pre-wrap;
        }
    </style>
</head>
<body>

    <h1>ðŸ§  MyndBand Visualizer</h1>
    <div id="status" class="status-bar">Ready to Connect</div>
    
    <button id="connectBtn">Connect Headset</button>

    <div class="dashboard">
        <div class="card">
            <div class="label">Focus</div>
            <div class="value" id="attention">--</div>
        </div>
        <div class="card">
            <div class="label">Relaxation</div>
            <div class="value" id="meditation">--</div>
        </div>
        <div class="card">
            <div class="label">Blink Strength</div>
            <div class="value" id="blink">--</div>
        </div>
        <div class="card">
            <div class="label">Signal Quality</div>
            <div class="value" style="font-size: 1.5em; line-height: 2.3;" id="signal">--</div>
        </div>
    </div>

    <div id="log"></div>

    <script>
        const btn = document.getElementById('connectBtn');
        const status = document.getElementById('status');
        const logEl = document.getElementById('log');

        // THIS IS THE KEY: The specific UUID you found
        const MYNDBAND_SERVICE = "039afff0-2c94-11e3-9e06-0002a5d5c51b";

        let device, server, characteristic;

        function updateStatus(msg, type='') {
            status.innerText = msg;
            status.className = `status-bar ${type}`;
            if(type === 'error') console.error(msg);
        }

        btn.addEventListener('click', async () => {
            try {
                updateStatus("Searching for device...");
                
                // 1. Request Device
                // We accept ANY device, but we explicitly ask for permission to use your specific Service UUID
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [MYNDBAND_SERVICE]
                });

                device.addEventListener('gattserverdisconnected', () => {
                    updateStatus("Device Disconnected", "error");
                    btn.disabled = false;
                    btn.innerText = "Connect Headset";
                });

                updateStatus("Connecting to Bluetooth...");
                
                // 2. Connect to GATT
                server = await device.gatt.connect();

                // 3. Get the specific Service
                updateStatus("Locating Data Stream...");
                const service = await server.getPrimaryService(MYNDBAND_SERVICE);
                
                // 4. Find the 'Notify' Characteristic
                // We don't guess the characteristic UUID; we just find the one that talks.
                const chars = await service.getCharacteristics();
                characteristic = chars.find(c => c.properties.notify);
                
                if (!characteristic) {
                    throw new Error("Service found, but no data stream (Notify) detected.");
                }

                // 5. Start Listening
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);
                
                updateStatus("Connected & Streaming", "connected");
                btn.disabled = true;
                btn.innerText = "Connected";

            } catch (error) {
                updateStatus(`Error: ${error.message}`, "error");
            }
        });

        // --- Data Parsing (ThinkGear Protocol) ---
        let buffer = [];

        function handleData(event) {
            const data = new Uint8Array(event.target.value.buffer);
            data.forEach(b => buffer.push(b));
            
            // Keep buffer healthy
            if (buffer.length > 512) buffer.shift();

            while (buffer.length >= 3) {
                // Check for Sync [0xAA, 0xAA]
                if (buffer[0] !== 0xAA || buffer[1] !== 0xAA) {
                    buffer.shift();
                    continue;
                }

                const len = buffer[2];
                if (buffer.length < 3 + len + 1) break; // Wait for full packet

                const payload = buffer.slice(3, 3 + len);
                const checksum = buffer[3 + len];
                const sum = payload.reduce((a, b) => a + b, 0);

                if (((~sum) & 0xFF) === checksum) {
                    parsePacket(payload);
                } else {
                    // console.log("Checksum fail"); // Common with wireless noise
                }

                buffer.splice(0, 3 + len + 1);
            }
        }

        function parsePacket(payload) {
            let i = 0;
            while (i < payload.length) {
                const code = payload[i++];
                
                if (code === 0x02) { // Signal Quality
                    const val = payload[i++];
                    const el = document.getElementById('signal');
                    if(val === 0) { el.innerText = "Good"; el.style.color = "#00b894"; }
                    else if(val === 200) { el.innerText = "Sensors Off"; el.style.color = "#d63031"; }
                    else { el.innerText = `Noise (${val})`; el.style.color = "#fdcb6e"; }
                } 
                else if (code === 0x04) { // Attention
                    document.getElementById('attention').innerText = payload[i++];
                } 
                else if (code === 0x05) { // Meditation
                    document.getElementById('meditation').innerText = payload[i++];
                } 
                else if (code === 0x16) { // Blink
                    document.getElementById('blink').innerText = payload[i++];
                } 
                else if (code === 0x80) { // Raw Wave (2 bytes)
                    i += 1; // skip length
                    i += 2; // skip val
                } 
                else if (code === 0x83) { // Bands (24 bytes)
                    i += 25; 
                }
                else {
                    // Unknown code? Stop parsing this packet to prevent errors
                    break;
                }
            }
        }
    </script>
</body>
</html>
