<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroScope V6: Aggressive</title>
    <style>
        :root { --bg: #000; --panel: #111; --text: #eee; --accent: #ff0055; --success: #00ff88; }
        body { font-family: 'Courier New', monospace; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        h1 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 5px; }
        .sub { color: #666; font-size: 0.8em; margin-bottom: 20px; }

        button { background: var(--accent); color: white; border: none; padding: 15px 30px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        button:hover { filter: brightness(1.2); }
        button:disabled { background: #333; cursor: default; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 900px; margin-bottom: 20px; }
        .card { background: var(--panel); border: 1px solid #333; padding: 20px; }
        
        .stat-big { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .stat-label { color: #888; font-size: 0.8em; text-transform: uppercase; }
        .active-a { border-color: var(--accent); box-shadow: 0 0 15px rgba(255, 0, 85, 0.2); }
        .active-b { border-color: var(--success); box-shadow: 0 0 15px rgba(0, 255, 136, 0.2); }

        /* Canvas */
        .scope-container { width: 100%; max-width: 900px; height: 300px; background: #050505; border: 1px solid #333; position: relative; margin-bottom: 20px; }
        canvas { width: 100%; height: 100%; display: block; }
        
        /* Log */
        #log { width: 100%; max-width: 900px; height: 200px; background: #080808; border: 1px solid #333; overflow-y: auto; font-size: 11px; padding: 10px; white-space: pre-wrap; color: #aaa; }
        .l-ok { color: var(--success); }
        .l-err { color: #555; }
        .l-warn { color: #ffaa00; }
    </style>
</head>
<body>

    <h1>NEUROSCOPE V6</h1>
    <div class="sub">Aggressive Service Discovery & Blind Injection</div>

    <button id="btn">AGGRESSIVE SCAN & INJECT</button>

    <div class="grid">
        <div class="card" id="box-a">
            <div class="stat-label">Channel A (Raw Candidate ...fff4)</div>
            <div class="stat-big" id="val-a">0</div>
            <div class="stat-label">Packets / Sec</div>
        </div>
        <div class="card" id="box-b">
            <div class="stat-label">Channel B (Summary ...fff8)</div>
            <div class="stat-big" id="val-b">0</div>
            <div class="stat-label">Packets / Sec</div>
        </div>
    </div>

    <div class="scope-container">
        <canvas id="graph"></canvas>
    </div>

    <div id="log">Ready. Click button to force connection...</div>

    <script>
        const btn = document.getElementById('btn');
        const logEl = document.getElementById('log');
        let countA = 0, countB = 0;
        let rawData = new Array(512).fill(0);
        let activeSource = null;

        function log(msg, type='') {
            const d = document.createElement('div');
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type) d.classList.add(type);
            logEl.appendChild(d);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Graph Setup
        const cvs = document.getElementById('graph');
        const ctx = cvs.getContext('2d');
        function resize() { cvs.width = cvs.parentElement.clientWidth; cvs.height = cvs.parentElement.clientHeight; }
        window.addEventListener('resize', resize);
        resize();

        btn.addEventListener('click', async () => {
            try {
                // 1. REQUEST DEVICE (Broad Filters)
                log("Scanning...", 'l-warn');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Mynd' }, { namePrefix: 'Mind' }, { namePrefix: 'Brain' }],
                    optionalServices: [
                        "039afff0-2c94-11e3-9e06-0002a5d5c51b", // MyndBand
                        "0000fff0-0000-1000-8000-00805f9b34fb", // ThinkGear
                        "0000ffe0-0000-1000-8000-00805f9b34fb"  // Serial
                    ]
                });

                log(`Connecting to ${device.name}...`);
                const server = await device.gatt.connect();
                log("Connected to GATT.", 'l-ok');

                // 2. GET ALL SERVICES (Avoids "Not Found" error by enumerating)
                const services = await server.getPrimaryServices();
                log(`Found ${services.length} Services.`, 'l-ok');

                for (const service of services) {
                    log(`Service: ${service.uuid}`);
                    const chars = await service.getCharacteristics();
                    
                    for (const c of chars) {
                        const uuid = c.uuid.substring(4,8);
                        log(`  > Char: ...${uuid} Props: ${getProps(c)}`);

                        // 3. BLIND WRITE BARRAGE
                        // Attempt to write 0x02 (Raw Mode) to EVERYTHING
                        const cmd = new Uint8Array([0x02]);
                        
                        // Try standard Write
                        if (c.properties.write) {
                            c.writeValue(cmd).then(() => log(`    [WRITE] Sent to ...${uuid}`, 'l-ok')).catch(e => log(`    [WRITE] Fail: ${e}`, 'l-err'));
                        }
                        // Try "Write Without Response" (Even if not advertised, we try!)
                        try {
                            await c.writeValueWithoutResponse(cmd);
                            log(`    [BLIND] Sent 0x02 to ...${uuid}!`, 'l-ok');
                        } catch(e) {
                            // Expected fail for Read-only
                        }

                        // 4. SUBSCRIBE
                        if (c.properties.notify) {
                            await c.startNotifications();
                            if (uuid.includes("fff4")) {
                                log(`    [LISTEN] Attached to Channel A (...fff4)`, 'l-ok');
                                c.addEventListener('characteristicvaluechanged', (e) => handle(e, 'A'));
                            } else if (uuid.includes("fff8")) {
                                log(`    [LISTEN] Attached to Channel B (...fff8)`, 'l-ok');
                                c.addEventListener('characteristicvaluechanged', (e) => handle(e, 'B'));
                            }
                        }
                    }
                }

                btn.disabled = true;
                btn.innerText = "RUNNING...";
                requestAnimationFrame(draw);
                setInterval(updateStats, 1000);

            } catch (e) {
                log("FATAL: " + e.message, 'l-err');
            }
        });

        function getProps(c) {
            let p = [];
            if(c.properties.read) p.push("R");
            if(c.properties.write) p.push("W");
            if(c.properties.notify) p.push("N");
            return p.join(',');
        }

        function handle(event, source) {
            const data = new Uint8Array(event.target.value.buffer);
            
            if(source === 'A') countA++;
            if(source === 'B') countB++;

            // If we get high speed data on A, switch source
            if(source === 'A' && activeSource !== 'A') {
                activeSource = 'A';
                document.getElementById('box-a').classList.add('active-a');
                document.getElementById('box-b').classList.remove('active-b');
                log("!!! RAW DATA DETECTED ON CHANNEL A !!!", 'l-ok');
            }

            // Simple Parse for Graph
            // We just look for raw packets roughly
            for(let i=0; i<data.length-1; i++) {
                // If we see 0x80 ... likely raw
                if(data[i] === 0x80 && (i+3 < data.length)) {
                    // Try to extract
                    let val = (data[i+2] << 8) | data[i+3];
                    if(val >= 32768) val -= 65536;
                    rawData.push(val);
                    rawData.shift();
                    i+=3;
                }
            }
        }

        function updateStats() {
            document.getElementById('val-a').innerText = countA;
            document.getElementById('val-b').innerText = countB;
            countA = 0; countB = 0;
        }

        function draw() {
            ctx.fillStyle = "black";
            ctx.fillRect(0,0, cvs.width, cvs.height);
            ctx.strokeStyle = activeSource === 'A' ? "#ff0055" : (activeSource === 'B' ? "#00ff88" : "#333");
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            let step = cvs.width / rawData.length;
            let mid = cvs.height / 2;
            
            for(let i=0; i<rawData.length; i++) {
                let y = mid - (rawData[i] * 0.15);
                if(i===0) ctx.moveTo(i*step, y);
                else ctx.lineTo(i*step, y);
            }
            ctx.stroke();
            requestAnimationFrame(draw);
        }
    </script>
</body>
</html>
