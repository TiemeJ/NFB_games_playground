<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyndBand Visualizer (Final)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 30px; color: #333; }
        
        /* Header */
        h1 { margin: 0; color: #2d3436; }
        .subtitle { color: #636e72; font-size: 0.9em; margin-bottom: 20px; }
        
        /* Status Bar */
        #status-box { padding: 10px 20px; background: #dfe6e9; border-radius: 30px; font-weight: bold; color: #636e72; margin-bottom: 20px; transition: 0.3s; }
        .connected { background: #00b894 !important; color: #fff !important; }
        
        button { padding: 15px 40px; font-size: 18px; font-weight: bold; background: #0984e3; color: white; border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        button:disabled { background: #b2bec3; transform: none; box-shadow: none; }

        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 800px; margin-top: 30px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; }
        
        .label { font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; color: #b2bec3; font-weight: bold; margin-bottom: 10px; }
        .value { font-size: 4em; font-weight: bold; color: #2d3436; line-height: 1; }
        
        /* Signal Quality Colors */
        .sig-good { color: #00b894; }
        .sig-bad { color: #d63031; }
        .sig-warn { color: #fdcb6e; }

        /* Bars */
        .bar-bg { width: 100%; height: 12px; background: #f1f2f6; border-radius: 6px; margin-top: 15px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease-out; }

        /* Debug Footer */
        .debug-area { margin-top: 40px; width: 100%; max-width: 800px; font-family: 'Courier New', monospace; font-size: 0.8em; }
        .debug-title { font-weight: bold; color: #b2bec3; border-bottom: 1px solid #ddd; margin-bottom: 5px; }
        #hex-log { color: #636e72; word-break: break-all; line-height: 1.5; }
        .highlight { background: #ffeaa7; color: #d35400; font-weight: bold; padding: 0 2px; }
    </style>
</head>
<body>

    <h1>ðŸ§  MyndBand Visualizer</h1>
    <div class="subtitle">Fixed Parser: Ignores Packet Counters</div>
    
    <div id="status-box">Ready</div>
    <button id="connectBtn">CONNECT</button>

    <div class="dashboard">
        <!-- Signal -->
        <div class="card" style="grid-column: span 2;">
            <div class="label">Signal Quality</div>
            <div class="value sig-bad" id="sig-val">--</div>
            <div style="font-size: 0.9em; margin-top: 5px; color: #aaa;" id="sig-desc">Connect headset</div>
        </div>

        <!-- Attention -->
        <div class="card">
            <div class="label">Focus</div>
            <div class="value" id="att-val">0</div>
            <div class="bar-bg"><div class="bar-fill" id="att-bar" style="background: #e17055;"></div></div>
        </div>

        <!-- Meditation -->
        <div class="card">
            <div class="label">Relaxation</div>
            <div class="value" id="med-val">0</div>
            <div class="bar-bg"><div class="bar-fill" id="med-bar" style="background: #00cec9;"></div></div>
        </div>
    </div>

    <div class="debug-area">
        <div class="debug-title">LIVE DATA STREAM (Hex)</div>
        <div id="hex-log">Waiting for data...</div>
    </div>

    <script>
        const btn = document.getElementById('connectBtn');
        const statusBox = document.getElementById('status-box');
        const hexLog = document.getElementById('hex-log');

        const SERVICE_UUID = "039afff0-2c94-11e3-9e06-0002a5d5c51b"; 

        btn.addEventListener('click', async () => {
            try {
                statusBox.innerText = "Scanning...";
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Mynd' }, { namePrefix: 'Mind' }, { namePrefix: 'Brain' }],
                    optionalServices: [SERVICE_UUID]
                });

                statusBox.innerText = "Connecting...";
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                const chars = await service.getCharacteristics();
                const notifyChar = chars.find(c => c.properties.notify);
                
                if (!notifyChar) throw new Error("No Data Stream Found");

                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleData);
                
                statusBox.innerText = "Connected & Streaming";
                statusBox.className = "connected";
                btn.innerText = "Connected";
                btn.disabled = true;

            } catch (e) {
                statusBox.innerText = "Error: " + e.message;
            }
        });

        // --- ROBUST PARSER ---
        let buffer = [];

        function handleData(event) {
            const data = new Uint8Array(event.target.value.buffer);
            
            // 1. Update Hex Log (Bottom of screen)
            let hexStr = "";
            for(let b of data) {
                buffer.push(b); // Add to internal buffer
                hexStr += b.toString(16).toUpperCase().padStart(2, '0') + " ";
            }
            // Keep log short
            if (hexLog.innerText.length > 300) hexLog.innerText = hexLog.innerText.slice(0, 300) + "..."; 
            hexLog.innerHTML = hexStr + " " + hexLog.innerHTML;

            // 2. Scan Buffer for Signature
            scanBuffer();
        }

        function scanBuffer() {
            // We look for the pattern: 02 [Sig] 04 [Att] 05 [Med]
            // This relies on the specific order seen in your screenshot.
            
            // Limit buffer size to prevent memory leaks
            if(buffer.length > 1024) buffer.shift();

            // We need at least 6 bytes for the pattern: 02 S 04 A 05 M
            for (let i = 0; i < buffer.length - 5; i++) {
                
                if (buffer[i] === 0x02 && buffer[i+2] === 0x04 && buffer[i+4] === 0x05) {
                    
                    const signal = buffer[i+1];
                    const attention = buffer[i+3];
                    const meditation = buffer[i+5];

                    updateUI(signal, attention, meditation);

                    // Optional: Highlight the find in the log?
                    // Remove processed bytes to avoid re-reading
                    buffer.splice(0, i + 6);
                    return; // Done for this pass
                }
            }
        }

        function updateUI(sig, att, med) {
            // Signal
            const sigVal = document.getElementById('sig-val');
            const sigDesc = document.getElementById('sig-desc');

            if (sig === 0) {
                sigVal.innerText = "Good";
                sigVal.className = "value sig-good";
                sigDesc.innerText = "Clean Signal (0)";
            } else if (sig === 200) {
                sigVal.innerText = "Sensors Off";
                sigVal.className = "value sig-bad";
                sigDesc.innerText = "Check skin contact (200)";
            } else {
                sigVal.innerText = "Noise";
                sigVal.className = "value sig-warn";
                sigDesc.innerText = `Interference level: ${sig}`;
            }

            // Attention
            document.getElementById('att-val').innerText = att;
            document.getElementById('att-bar').style.width = att + "%";
            
            // Meditation
            document.getElementById('med-val').innerText = med;
            document.getElementById('med-bar').style.width = med + "%";
        }
    </script>
</body>
</html>
