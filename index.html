<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroScope V4: Deep Serial</title>
    <style>
        :root { --bg: #000000; --card: #141414; --text: #d0d0d0; --accent: #00ff88; --err: #ff4444; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        h1 { margin: 0; color: #fff; letter-spacing: 2px; border-bottom: 2px solid var(--accent); padding-bottom: 5px; }
        .subtitle { color: #888; font-size: 0.8em; margin-bottom: 20px; margin-top: 5px; }
        
        button { padding: 15px 30px; font-size: 16px; font-weight: bold; background: var(--accent); color: #000; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 20px; }
        button:hover { box-shadow: 0 0 15px var(--accent); }
        button:disabled { background: #333; color: #555; box-shadow: none; cursor: default; }

        .dashboard { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; max-width: 900px; }
        .card { background: var(--card); padding: 15px; border: 1px solid #333; border-radius: 6px; }

        /* Stats Grid */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stat-box { background: #1a1a1a; padding: 10px; text-align: center; border: 1px solid #333; }
        .stat-val { font-size: 1.5em; font-weight: bold; color: #fff; }
        .stat-lbl { font-size: 0.7em; color: var(--accent); text-transform: uppercase; }

        /* Canvas */
        .canvas-wrap { width: 100%; height: 300px; background: #050505; border: 1px solid #333; position: relative; }
        canvas { width: 100%; height: 100%; display: block; }

        /* Log */
        #log { font-size: 11px; height: 200px; overflow-y: auto; white-space: pre-wrap; color: #aaa; background: #111; padding: 10px; border: 1px solid #333; }
        .l-inf { color: #fff; }
        .l-suc { color: var(--accent); }
        .l-err { color: var(--err); }
        .l-wrn { color: #ffbb00; }
    </style>
</head>
<body>

    <h1>NEUROSCOPE V4</h1>
    <div class="subtitle">Serial/UART Override Mode</div>

    <button id="btnConnect">DEEP SCAN & CONNECT</button>

    <div class="dashboard">
        <div class="stats">
            <div class="stat-box">
                <div class="stat-lbl">Speed</div>
                <div class="stat-val" id="v-pps">0 pps</div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">Signal</div>
                <div class="stat-val" id="v-sig">--</div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">Att / Med</div>
                <div class="stat-val"><span id="v-att">--</span> / <span id="v-med">--</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-lbl">Mode</div>
                <div class="stat-val" id="v-mode" style="font-size:0.8em; line-height:2.5;">WAITING</div>
            </div>
        </div>

        <div class="card">
            <div class="canvas-wrap"><canvas id="scope"></canvas></div>
        </div>

        <div class="card">
            <div style="font-size:10px; color:#666; margin-bottom:5px;">SYSTEM LOG</div>
            <div id="log">Ready to scan...</div>
        </div>
    </div>

    <script>
        // ════ CONFIG ════
        // We look for these services in order of preference
        // 1. HM-10 / Serial (Common on older NeuroSky bridges)
        const UUID_SERIAL = "0000ffe0-0000-1000-8000-00805f9b34fb"; 
        // 2. MyndBand / ThinkGear (What you connected to before)
        const UUID_TG     = "039afff0-2c94-11e3-9e06-0002a5d5c51b"; 

        // ════ STATE ════
        let device, server;
        let dataChar, writeChar;
        let packetCount = 0;
        let buffer = [];
        let rawBuffer = new Array(1024).fill(0);
        
        // ════ UI ════
        const canvas = document.getElementById('scope');
        const ctx = canvas.getContext('2d');
        const logEl = document.getElementById('log');

        function log(msg, cls='') {
            const d = document.createElement('div');
            d.innerText = "> " + msg;
            if(cls) d.classList.add(cls);
            logEl.appendChild(d);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // ════ CORE ════
        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                log("Requesting Device (All Services)...", 'l-inf');
                
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Mynd' }, { namePrefix: 'Mind' }, { namePrefix: 'Brain' }],
                    // IMPORTANT: We must ask for permission to access ALL likely services
                    optionalServices: [UUID_SERIAL, UUID_TG]
                });

                log(`Connecting to ${device.name}...`);
                server = await device.gatt.connect();
                log("Connected.", 'l-suc');

                // ─── STRATEGY 1: HUNT FOR SERIAL (FFE0) ───
                let service = null;
                let mode = "";

                try {
                    log("Attempting UART/Serial (FFE0)...", 'l-wrn');
                    service = await server.getPrimaryService(UUID_SERIAL);
                    mode = "SERIAL";
                    log("Serial Service FOUND!", 'l-suc');
                } catch(e) {
                    log("Serial Service not found.", 'l-inf');
                }

                // ─── STRATEGY 2: FALLBACK TO THINKGEAR (FFF0) ───
                if (!service) {
                    try {
                        log("Falling back to ThinkGear (FFF0)...", 'l-wrn');
                        service = await server.getPrimaryService(UUID_TG);
                        mode = "THINKGEAR";
                        log("ThinkGear Service FOUND!", 'l-suc');
                    } catch(e) {
                        throw new Error("No compatible service found!");
                    }
                }

                document.getElementById('v-mode').innerText = mode;

                // ─── CHARACTERISTIC DISCOVERY ───
                log("Scanning Characteristics...", 'l-inf');
                const chars = await service.getCharacteristics();
                
                // Reset
                dataChar = null;
                writeChar = null;

                for (const c of chars) {
                    const u = c.uuid.substring(4, 8); // Short UUID
                    const p = [];
                    if(c.properties.read) p.push("R");
                    if(c.properties.write) p.push("W");
                    if(c.properties.writeWithoutResponse) p.push("WnR");
                    if(c.properties.notify) p.push("N");
                    
                    log(`UUID: ...${u} [${p.join(',')}]`);

                    // 1. Find Data Channel (Notify)
                    // If FFF0 service: Prefer FFF8 over FFF4
                    // If FFE0 service: Prefer FFE1
                    if (c.properties.notify) {
                        if (mode === "THINKGEAR") {
                            if (u.includes("fff8")) dataChar = c; // PRIORITY
                            else if (!dataChar) dataChar = c; // Fallback
                        } else {
                            dataChar = c; // Serial usually only has one
                        }
                    }

                    // 2. Find Write Channel
                    if (c.properties.write || c.properties.writeWithoutResponse) {
                        writeChar = c;
                    }
                }

                if (!dataChar) throw new Error("No Data Channel (Notify) found!");
                
                log(`Selected Data: ...${dataChar.uuid.substring(4,8)}`, 'l-suc');
                if (writeChar) log(`Selected Write: ...${writeChar.uuid.substring(4,8)}`, 'l-suc');
                else log("WARNING: No Write Channel found (Read Only)", 'l-err');

                // ─── CONNECT STREAM ───
                await dataChar.startNotifications();
                dataChar.addEventListener('characteristicvaluechanged', handleData);
                log("Stream Started.", 'l-suc');
                document.getElementById('btnConnect').disabled = true;

                // ─── ATTEMPT UNLOCK ───
                if (writeChar) {
                    // Try to force raw mode
                    log("Sending Unlock Commands...", 'l-wrn');
                    
                    // Command Sequence for various chips:
                    // 1. 0x02 (NeuroSky standard "Raw Mode")
                    // 2. 0x00 (Dump/Stream)
                    // 3. String "c" (Some serial bridges)
                    
                    try {
                        const cmd1 = new Uint8Array([0x02]); 
                        await writeChar.writeValue(cmd1);
                        log("Sent CMD: 0x02", 'l-inf');
                    } catch(e) { log("CMD 0x02 Failed", 'l-err'); }

                } else {
                    log("Cannot send commands (Read Only). Hoping for default stream...", 'l-wrn');
                }

                // Start Visuals
                draw();
                setInterval(() => {
                    document.getElementById('v-pps').innerText = packetCount + " pps";
                    // Color code PPS
                    const s = document.getElementById('v-pps').style;
                    s.color = packetCount > 100 ? "#0f0" : (packetCount > 0 ? "#fa0" : "#555");
                    packetCount = 0;
                }, 1000);

            } catch (e) {
                log("FATAL: " + e.message, 'l-err');
            }
        });

        // ════ PARSER ════
        function handleData(event) {
            const data = new Uint8Array(event.target.value.buffer);
            packetCount++;

            for (let i=0; i<data.length; i++) buffer.push(data[i]);
            
            // Limit buffer
            if (buffer.length > 2048) buffer.splice(0, 1024);

            processBuffer();
        }

        function processBuffer() {
            while (buffer.length >= 3) {
                // Check for Sync [AA] [AA]
                if (buffer[0] === 0xAA && buffer[1] === 0xAA) {
                    const len = buffer[2];
                    if (buffer.length >= 3 + len + 1) {
                        const payload = buffer.slice(3, 3 + len);
                        const checksum = buffer[3 + len];
                        
                        // Checksum Calc
                        let sum = 0;
                        for (let b of payload) sum += b;
                        sum = (~sum) & 0xFF;

                        if (sum === checksum) {
                            parsePayload(payload);
                            buffer.splice(0, 3 + len + 1);
                        } else {
                            buffer.shift(); // Bad checksum
                        }
                    } else { return; } // Need more bytes
                } else {
                    buffer.shift(); // Not sync
                }
            }
        }

        function parsePayload(payload) {
            let i = 0;
            while (i < payload.length) {
                const code = payload[i];
                
                if (code === 0x80) { // RAW WAVE
                    const val = (payload[i+1] << 8) | payload[i+2];
                    let raw = val;
                    if (raw >= 32768) raw -= 65536;
                    
                    rawBuffer.push(raw);
                    rawBuffer.shift();
                    i += 4; // 1(code) + 1(len) + 2(val) -- WAIT. ThinkGear spec says 0x80 [LEN] [VAL_H] [VAL_L]
                    // Wait, standard spec:
                    // [0x80] [0x02] [High] [Low]
                    // My previous code assumed strict format. Let's verify Length byte.
                } 
                else if (code === 0x02) { // Signal
                    const q = payload[i+1];
                    document.getElementById('v-sig').innerText = q === 0 ? "GOOD" : (q===200?"OFF":q);
                    document.getElementById('v-sig').style.color = q===0 ? "#0f0" : "#f00";
                    i += 2;
                }
                else if (code === 0x04) { // Att
                    document.getElementById('v-att').innerText = payload[i+1];
                    i += 2;
                }
                else if (code === 0x05) { // Med
                    document.getElementById('v-med').innerText = payload[i+1];
                    i += 2;
                }
                else {
                    i++;
                }
            }
        }

        // ════ RENDER ════
        function draw() {
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = "#00ff88";
            ctx.lineWidth = 1.5;
            ctx.beginPath();

            const h = canvas.height;
            const w = canvas.width;
            const mid = h / 2;
            const len = rawBuffer.length;
            const step = w / len;

            for(let i=0; i<len; i++) {
                const x = i * step;
                // Scale factor: +/- 2048 -> +/- h/2
                const y = mid - (rawBuffer[i] * (h/1000)); // Zoom
                if(i===0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            requestAnimationFrame(draw);
        }
    </script>
</body>
</html>
