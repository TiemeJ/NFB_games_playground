<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyndBand Deep Debug</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #111; color: #0f0; padding: 20px; max-width: 900px; margin: 0 auto; }
        h1 { border-bottom: 1px solid #333; padding-bottom: 10px; color: #fff; }
        
        .status-box { padding: 10px; border: 1px solid #444; margin-bottom: 20px; background: #222; }
        .status-ok { color: #0f0; font-weight: bold; }
        .status-err { color: #f55; font-weight: bold; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        button { padding: 15px; font-family: inherit; font-weight: bold; cursor: pointer; border: none; }
        #btnConnect { background: #007bff; color: white; }
        #btnKick { background: #d35400; color: white; }
        button:disabled { background: #555; cursor: not-allowed; }

        #data-log { 
            background: #000; border: 1px solid #444; height: 300px; 
            overflow-y: scroll; padding: 10px; white-space: pre-wrap; 
            font-size: 0.9em; line-height: 1.4; color: #ccc;
        }
        .byte-stream { color: #888; word-break: break-all; margin-top: 10px; }
        .parsed-val { color: #fff; font-weight: bold; }
        .sync-byte { color: #007bff; }
    </style>
</head>
<body>

    <h1>üïµÔ∏è MyndBand Raw Inspector</h1>
    
    <div class="status-box">
        STATUS: <span id="status">Disconnected</span><br>
        BYTES RECEIVED: <span id="byteCount">0</span>
    </div>

    <div class="controls">
        <button id="btnConnect">1. CONNECT (Deep Scan)</button>
        <button id="btnKick" disabled>2. KICKSTART (If Silent)</button>
    </div>

    <div id="data-log">Log is empty... waiting for connection.</div>

    <script>
        const btnConnect = document.getElementById('btnConnect');
        const btnKick = document.getElementById('btnKick');
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('data-log');
        const byteCountEl = document.getElementById('byteCount');

        const TARGET_SERVICE = "039afff0-2c94-11e3-9e06-0002a5d5c51b";
        
        let device, server, notifyChar, writeChar;
        let totalBytes = 0;

        function log(msg, isRaw = false) {
            if(isRaw) {
                // Just append text for raw data to avoid newline spam
                logEl.innerHTML += msg + " ";
            } else {
                const div = document.createElement('div');
                div.innerHTML = `> ${msg}`;
                div.style.color = "#0f0";
                logEl.appendChild(div);
            }
            logEl.scrollTop = logEl.scrollHeight;
        }

        btnConnect.addEventListener('click', async () => {
            try {
                log("Requesting Device...");
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [TARGET_SERVICE]
                });

                log(`Device: ${device.name}`);
                server = await device.gatt.connect();
                log("GATT Connected.");

                const service = await server.getPrimaryService(TARGET_SERVICE);
                log(`Service ${TARGET_SERVICE} found.`);

                const chars = await service.getCharacteristics();
                log(`Found ${chars.length} characteristics in service.`);

                // Find Notify (Read) and Write characteristics
                notifyChar = chars.find(c => c.properties.notify);
                writeChar = chars.find(c => c.properties.write || c.properties.writeWithoutResponse);

                if(writeChar) {
                    log(`Write Channel Found: ${writeChar.uuid}`);
                    btnKick.disabled = false;
                } else {
                    log("No Write Channel found (Passive Mode).");
                }

                if(notifyChar) {
                    log(`Subscribing to Notify: ${notifyChar.uuid}`);
                    await notifyChar.startNotifications();
                    notifyChar.addEventListener('characteristicvaluechanged', handleRawData);
                    statusEl.innerText = "CONNECTED & LISTENING";
                    statusEl.className = "status-ok";
                    btnConnect.disabled = true;
                    log("--- STREAM STARTED. WATCH BELOW ---");
                } else {
                    log("ERROR: No Notify characteristic found!", "err");
                }

            } catch(e) {
                log(`ERROR: ${e.message}`);
                statusEl.innerText = "Error";
                statusEl.className = "status-err";
            }
        });

        // KICKSTART: Try to force the device to talk
        btnKick.addEventListener('click', async () => {
            if(!writeChar) return;
            log("Sending 'Start' commands...");
            try {
                // Common commands for serial bridges
                const cmd1 = new Uint8Array([0x01]); // Often "Start"
                const cmd2 = new TextEncoder().encode("b"); // Sometimes text command
                
                await writeChar.writeValue(cmd1);
                log("Sent Byte: 0x01");
                
                // Wait a bit and try another if needed
                setTimeout(async () => {
                     // await writeChar.writeValue(cmd2); // Uncomment if needed
                }, 500);
            } catch(e) {
                log(`Write Error: ${e.message}`);
            }
        });

        // RAW DATA HANDLER
        // We print every byte. If we see "AA AA", we highlight it.
        function handleRawData(event) {
            const data = new Uint8Array(event.target.value.buffer);
            totalBytes += data.byteLength;
            byteCountEl.innerText = totalBytes;

            let hexString = "";
            for(let i=0; i<data.length; i++) {
                const b = data[i];
                const h = b.toString(16).toUpperCase().padStart(2, '0');
                
                // Highlight ThinkGear Sync Bytes
                if(b === 0xAA) {
                    hexString += `<span class="sync-byte">${h}</span> `;
                } else {
                    hexString += `${h} `;
                }
            }
            
            // Print raw hex to screen
            log(hexString, true);
        }
    </script>
</body>
</html>
