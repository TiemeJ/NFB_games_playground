<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroScope V14: Raw Terminal</title>
    <style>
        :root { --bg: #1e1e1e; --term: #000; --text: #0f0; --btn: #333; --accent: #00ff00; }
        body { font-family: 'Consolas', 'Monaco', monospace; background: var(--bg); color: #ccc; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        h1 { color: #fff; border-bottom: 2px solid var(--text); padding-bottom: 10px; }
        
        /* Layout */
        .container { display: grid; grid-template-columns: 1fr 300px; gap: 20px; width: 100%; max-width: 1000px; height: 500px; }
        
        /* Terminal */
        .terminal { background: var(--term); border: 2px solid #555; padding: 15px; overflow-y: auto; font-size: 12px; color: var(--text); display: flex; flex-direction: column-reverse; }
        .term-line { margin-bottom: 2px; border-bottom: 1px solid #111; }
        .ts { color: #666; margin-right: 10px; }
        
        /* Controls */
        .controls { display: flex; flex-direction: column; gap: 15px; }
        
        button { padding: 12px; background: var(--btn); color: #fff; border: 1px solid #555; cursor: pointer; font-family: inherit; transition: 0.2s; }
        button:hover { background: #444; border-color: #fff; }
        button.connect { background: var(--accent); color: #000; font-weight: bold; }
        
        .stat-box { background: #252526; padding: 10px; border: 1px solid #333; }
        .stat-val { font-size: 1.5em; font-weight: bold; color: #fff; }
        .stat-lbl { font-size: 0.7em; text-transform: uppercase; color: #888; }
        
        .byte-cnt { color: #fff; }
    </style>
</head>
<body>

    <h1>NEUROSCOPE V14: RAW TERMINAL</h1>
    
    <div class="container">
        <div class="terminal" id="term">
            <div class="term-line">> Ready. Waiting for connection...</div>
        </div>

        <div class="controls">
            <button id="btn-conn" class="connect">CONNECT</button>
            
            <div class="stat-box">
                <div class="stat-lbl">Incoming Data</div>
                <div class="stat-val" id="byte-counter">0 Bytes</div>
                <div class="stat-lbl" id="pps-counter">0 PPS</div>
            </div>

            <div style="font-size:0.8em; color:#aaa; margin-top:10px;">MANUAL KICK (INJECT)</div>
            <button onclick="sendHex([0x02])">TX: 0x02 (BIN)</button>
            <button onclick="sendStr('c')">TX: "c" (ASCII)</button>
            <button onclick="sendHex([0x00])">TX: 0x00 (BIN)</button>
            <button onclick="sendHex([0xC2])">TX: 0xC2 (LEGACY)</button>
            <button onclick="sendHex([0x02, 0x00])">TX: 02 00 (SEQ)</button>
        </div>
    </div>

    <script>
        // ════ CONFIG ════
        const SERVICES = [
            "0000ffe0-0000-1000-8000-00805f9b34fb", // Serial
            "039afff0-2c94-11e3-9e06-0002a5d5c51b", // MyndBand
            "0000fff0-0000-1000-8000-00805f9b34fb"  // Standard
        ];

        // ════ STATE ════
        let device, server;
        let writeChar = null;
        let totalBytes = 0;
        let pps = 0;

        // ════ UI ════
        const term = document.getElementById('term');
        const countEl = document.getElementById('byte-counter');
        const ppsEl = document.getElementById('pps-counter');

        function log(msg, isData = false) {
            const line = document.createElement('div');
            line.className = 'term-line';
            const time = new Date().toISOString().split('T')[1].split('.')[0];
            
            if (isData) {
                line.innerHTML = `<span class="ts">[${time}]</span> <span style="color:#fff">${msg}</span>`;
            } else {
                line.innerHTML = `<span class="ts">[${time}]</span> <span style="color:#aaa">${msg}</span>`;
            }
            
            term.prepend(line); // Add to top
            if(term.children.length > 100) term.lastElementChild.remove();
        }

        // ════ CONNECT ════
        document.getElementById('btn-conn').addEventListener('click', async () => {
            try {
                log("Scanning...");
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Mynd' }, { namePrefix: 'Mind' }, { namePrefix: 'Brain' }],
                    optionalServices: SERVICES
                });

                log(`Connecting to ${device.name}...`);
                server = await device.gatt.connect();
                log("Connected to GATT.");

                // SCAN SERVICES
                const services = await server.getPrimaryServices();
                log(`Found ${services.length} Services.`);

                for (const s of services) {
                    const chars = await s.getCharacteristics();
                    for (const c of chars) {
                        const uuid = c.uuid.substring(4,8);
                        let props = [];
                        if(c.properties.write) props.push("W");
                        if(c.properties.writeWithoutResponse) props.push("WnR");
                        if(c.properties.notify) props.push("N");
                        
                        log(`Found ...${uuid} [${props.join(',')}]`);

                        // 1. SETUP LISTENER
                        if (c.properties.notify) {
                            await c.startNotifications();
                            c.addEventListener('characteristicvaluechanged', (e) => {
                                handleData(e, uuid);
                            });
                            log(`>>> LISTENING ON ...${uuid}`);
                        }

                        // 2. SETUP WRITER (Prefer FFE1 or first available)
                        if ((c.properties.write || c.properties.writeWithoutResponse) && !writeChar) {
                            writeChar = c;
                            log(`<<< WRITER SET TO ...${uuid}`);
                        }
                        // Force override if we find FFE1 (Serial)
                        if (uuid.includes('ffe1')) {
                            writeChar = c;
                            log(`<<< WRITER UPDATED TO SERIAL (...ffe1)`);
                        }
                    }
                }

                log("SYSTEM READY. Waiting for data...");
                setInterval(() => {
                    ppsEl.innerText = pps + " Packets/Sec";
                    pps = 0;
                }, 1000);

            } catch (e) {
                log("ERROR: " + e.message);
            }
        });

        // ════ DATA HANDLER ════
        function handleData(event, uuid) {
            pps++;
            const data = new Uint8Array(event.target.value.buffer);
            totalBytes += data.length;
            countEl.innerText = totalBytes.toLocaleString() + " Bytes";

            // FORMAT HEX
            let hexStr = "";
            for(let b of data) {
                hexStr += b.toString(16).toUpperCase().padStart(2, '0') + " ";
            }
            
            // Log it (Only if slow, or sample if fast)
            if(pps < 10 || pps % 20 === 0) {
                log(`RX [${uuid}]: ${hexStr}`, true);
            }
        }

        // ════ SEND COMMANDS ════
        window.sendHex = async function(arr) {
            if(!writeChar) { log("NO WRITE CHANNEL!"); return; }
            try {
                const data = new Uint8Array(arr);
                if(writeChar.properties.writeWithoutResponse) {
                    await writeChar.writeValueWithoutResponse(data);
                } else {
                    await writeChar.writeValue(data);
                }
                log(`TX: [${arr.map(b=>b.toString(16).toUpperCase()).join(' ')}]`);
            } catch(e) { log("TX FAIL: " + e.message); }
        }

        window.sendStr = async function(str) {
            if(!writeChar) { log("NO WRITE CHANNEL!"); return; }
            try {
                const enc = new TextEncoder();
                const data = enc.encode(str);
                await writeChar.writeValue(data);
                log(`TX: "${str}"`);
            } catch(e) { log("TX FAIL: " + e.message); }
        }
    </script>
</body>
</html>
