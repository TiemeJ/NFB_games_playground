<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroScope V3: Diagnostic</title>
    <style>
        :root { --bg: #0b0c10; --card: #1f2833; --text: #c5c6c7; --accent: #66fcf1; --warn: #45a29e; }
        body { font-family: 'Consolas', 'Monaco', monospace; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        
        h1 { margin: 0; color: #fff; letter-spacing: 2px; }
        .subtitle { color: var(--warn); font-size: 0.9em; margin-bottom: 20px; }
        
        /* Controls */
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        button { padding: 12px 24px; font-size: 14px; font-weight: bold; background: var(--accent); color: #0b0c10; border: none; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
        button:hover { filter: brightness(1.2); }
        button:disabled { background: #333; color: #555; cursor: not-allowed; }
        
        .btn-force { background: #ff5252; color: #fff; }

        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: 1fr; gap: 20px; width: 100%; max-width: 1000px; }
        .card { background: var(--card); padding: 15px; border-radius: 5px; border: 1px solid #333; }
        
        /* Canvas */
        .canvas-container { width: 100%; height: 300px; background: #000; border-radius: 4px; position: relative; border: 1px solid #444; }
        canvas { display: block; width: 100%; height: 100%; }

        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; }
        .stat-box { background: #000; padding: 10px; text-align: center; border-radius: 4px; border: 1px solid #333; }
        .stat-val { font-size: 1.4em; font-weight: bold; color: var(--accent); }
        .stat-label { font-size: 0.7em; color: #888; text-transform: uppercase; }

        /* Debug Log */
        #debug-log { 
            font-size: 11px; 
            color: #0f0; 
            height: 200px; 
            overflow-y: auto; 
            background: #000; 
            padding: 15px; 
            border: 1px solid #333;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.4;
        }
        .log-warn { color: #ffcc00; }
        .log-err { color: #ff5252; }
        .log-success { color: #66fcf1; }
    </style>
</head>
<body>

    <h1>NEUROSCOPE <span style="color:var(--warn)">V3</span></h1>
    <div class="subtitle">Diagnostic Mode • Auto-Discovery</div>

    <div class="controls">
        <button id="connectBtn">1. SCAN & CONNECT</button>
        <button id="forceBtn" class="btn-force" disabled>2. SEND RAW CMD (0x02)</button>
    </div>

    <div class="dashboard">
        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-label">Packet Rate</div>
                <div class="stat-val" id="val-fps">0 pps</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Signal</div>
                <div class="stat-val" id="val-quality">--</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Att / Med</div>
                <div class="stat-val"><span id="val-att">--</span> / <span id="val-med">--</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Last Packet</div>
                <div class="stat-val" id="val-last" style="font-size: 0.8em; color: #888;">None</div>
            </div>
        </div>

        <div class="card">
            <div class="canvas-container">
                <canvas id="rawCanvas"></canvas>
            </div>
        </div>

        <div class="card">
            <div style="margin-bottom:5px; color:#888; font-size:10px; font-weight:bold;">DEVICE LOG</div>
            <div id="debug-log">> Ready. Click 'Scan & Connect' to begin diagnostics...</div>
        </div>
    </div>

    <script>
        // ════ STATE ════
        let device, server, service;
        let notifyChar = null;
        let writeChar = null;
        let packetCount = 0;
        
        // Buffers
        const RAW_SIZE = 512 * 4; 
        let rawBuffer = new Array(RAW_SIZE).fill(0);
        
        // UI
        const rawCanvas = document.getElementById('rawCanvas');
        const ctx = rawCanvas.getContext('2d');
        const debugEl = document.getElementById('debug-log');
        
        function resize() {
            rawCanvas.width = rawCanvas.parentElement.clientWidth;
            rawCanvas.height = rawCanvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function log(msg, type='') {
            const line = document.createElement('div');
            line.innerText = "> " + msg;
            if (type) line.classList.add('log-'+type);
            debugEl.appendChild(line);
            debugEl.scrollTop = debugEl.scrollHeight;
        }

        // ════ BLUETOOTH ════
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                log("Requesting Device...", 'warn');
                // We ask for ALL services to ensure we don't miss the Write channel
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Mynd' }, { namePrefix: 'Mind' }, { namePrefix: 'Brain' }],
                    optionalServices: [
                        "0000fff0-0000-1000-8000-00805f9b34fb", // Standard
                        "039afff0-2c94-11e3-9e06-0002a5d5c51b"  // MyndBand Custom
                    ]
                });

                log(`Connecting to: ${device.name}...`);
                server = await device.gatt.connect();
                log("Connected to GATT Server.", 'success');

                // 1. DISCOVER SERVICES
                log("Getting Primary Service...");
                try {
                    // Try the custom UUID first (MyndBand specific)
                    service = await server.getPrimaryService("039afff0-2c94-11e3-9e06-0002a5d5c51b");
                } catch(e) {
                    log("Custom UUID failed, trying Standard UUID...");
                    service = await server.getPrimaryService("0000fff0-0000-1000-8000-00805f9b34fb");
                }
                log(`Service Found: ${service.uuid}`, 'success');

                // 2. DISCOVER CHARACTERISTICS (The Diagnostic Part)
                log("--- SCANNED CHARACTERISTICS ---", 'warn');
                const chars = await service.getCharacteristics();
                
                for (const c of chars) {
                    let props = [];
                    if (c.properties.read) props.push("READ");
                    if (c.properties.write) props.push("WRITE");
                    if (c.properties.writeWithoutResponse) props.push("WRITE_NO_RESP");
                    if (c.properties.notify) props.push("NOTIFY");
                    
                    const uuidShort = c.uuid.split('-')[0]; // First 8 chars
                    log(`UUID: ...${uuidShort} | Props: [${props.join(', ')}]`);

                    // Auto-assign Notify
                    if (c.properties.notify && !notifyChar) {
                        notifyChar = c;
                        log(`  -> Selected for DATA STREAM (Notify)`, 'success');
                    }

                    // Auto-assign Write (Prioritize generic write)
                    if ((c.properties.write || c.properties.writeWithoutResponse) && !writeChar) {
                        writeChar = c;
                        log(`  -> Selected for COMMANDS (Write)`, 'success');
                    }
                }
                log("---------------------------------");

                if (!notifyChar) throw new Error("No Notify Characteristic found!");
                
                // 3. START STREAM
                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleData);
                log("Listening for data...", 'success');

                // Update UI
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').innerText = "CONNECTED";
                if (writeChar) {
                    document.getElementById('forceBtn').disabled = false;
                    document.getElementById('forceBtn').innerText = "2. SEND RAW CMD (0x02)";
                } else {
                    log("WARNING: Read-Only mode. No Write channel found.", 'err');
                }

                // Start Visuals
                requestAnimationFrame(drawLoop);
                setInterval(() => {
                    document.getElementById('val-fps').innerText = packetCount + " pps";
                    packetCount = 0;
                }, 1000);

            } catch (e) {
                log("ERROR: " + e.message, 'err');
            }
        });

        // ════ COMMAND INJECTION ════
        document.getElementById('forceBtn').addEventListener('click', async () => {
            if (!writeChar) return;
            try {
                // Command: 0x02 (Change Baud to 57600 / Raw Mode)
                const cmd = new Uint8Array([0x02]); 
                // Note: If 0x02 fails, try 0x00, or string "0x02"
                
                log(`Sending 0x02 to ...${writeChar.uuid.split('-')[0]}...`);
                await writeChar.writeValue(cmd);
                log("Command Sent!", 'success');
            } catch(e) {
                log("Write Failed: " + e.message, 'err');
            }
        });

        // ════ PARSER ════
        let buffer = []; 
        
        function handleData(event) {
            const data = new Uint8Array(event.target.value.buffer);
            packetCount++;

            // HEX DUMP DEBUG (Sample first packet of every second to keep log clean)
            if (packetCount === 1) {
                 const hex = Array.from(data).map(b => b.toString(16).padStart(2,'0').toUpperCase()).join(' ');
                 document.getElementById('val-last').innerText = hex;
                 // log(`RX: ${hex}`);
            }

            // Push to main buffer
            for (let i=0; i<data.length; i++) buffer.push(data[i]);
            if (buffer.length > 2048) buffer.splice(0, 1024); // Safety cap

            processBuffer();
        }

        function processBuffer() {
            while (buffer.length >= 3) {
                // Check 1: Standard NeuroSky [AA] [AA]
                if (buffer[0] === 0xAA && buffer[1] === 0xAA) {
                    const len = buffer[2];
                    if (buffer.length >= 3 + len + 1) {
                        const payload = buffer.slice(3, 3 + len);
                        const checksum = buffer[3 + len];
                        
                        // Verify Checksum
                        let sum = 0;
                        for (let b of payload) sum += b;
                        sum = (~sum) & 0xFF;

                        if (sum === checksum) {
                            parsePayload(payload);
                            buffer.splice(0, 3 + len + 1); // Consume packet
                        } else {
                            buffer.shift(); // Bad Checksum
                        }
                    } else {
                        return; // Wait for more data
                    }
                } 
                // Check 2: MyndBand Wrapper [00] [00]
                else if (buffer[0] === 0x00 && buffer[1] === 0x00) {
                    // Just strip the 00 00 and let the next loop find the inner data
                    buffer.shift(); buffer.shift(); 
                }
                else {
                    buffer.shift(); // Garbage
                }
            }
        }

        function parsePayload(payload) {
            let i = 0;
            while (i < payload.length) {
                const code = payload[i];
                
                if (code === 0x80) { // RAW (2 bytes)
                    // Raw value is 16-bit big endian signed
                    const val = (payload[i+1] << 8) | payload[i+2];
                    let raw = val;
                    if (raw >= 32768) raw -= 65536;
                    
                    rawBuffer.push(raw);
                    rawBuffer.shift();
                    i += 3; // code + 2 bytes
                }
                else if (code === 0x02) { // Signal Quality
                    const q = payload[i+1];
                    document.getElementById('val-quality').innerText = q === 0 ? "Good" : (q===200?"Off":"Noise");
                    i += 2;
                }
                else if (code === 0x04) { // Attention
                    document.getElementById('val-att').innerText = payload[i+1];
                    i += 2;
                }
                else if (code === 0x05) { // Meditation
                    document.getElementById('val-med').innerText = payload[i+1];
                    i += 2;
                }
                else {
                    i++; // Skip unknown
                }
            }
        }

        // ════ RENDER ════
        function drawLoop() {
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, rawCanvas.width, rawCanvas.height);
            
            ctx.strokeStyle = "#66fcf1";
            ctx.lineWidth = 2;
            ctx.beginPath();

            const slice = rawBuffer.slice(rawBuffer.length - 1024); // Last ~2 seconds
            const w = rawCanvas.width;
            const h = rawCanvas.height;
            const step = w / slice.length;

            for (let i = 0; i < slice.length; i++) {
                const x = i * step;
                // Auto-Gain: Scale visualization based on signal strength
                // Raw is +/- 2048 typically.
                const y = (h/2) - (slice[i] * 0.1); 
                if (i===0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            requestAnimationFrame(drawLoop);
        }
    </script>
</body>
</html>
